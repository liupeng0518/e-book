---
title: 源码编译docker-ce
date: 2020-01-09 09:47:19
categories: docker
tags: [docker, mips64el, source]
---


目前需要在mips64el 3B4000 下适配编译`UOS 20`的`docker-ce 18.09/18.06`版本。

这里记录下18.06的编译，09如法炮制：

# 编译环境
- OS: UOS 20
- ARCH: mips64el
- go: 1.12.5

# containerd
```
---
 Makefile.linux                                     |   2 +-
 cmd/ctr/commands/signal_map_linux.go               |   1 -
 vendor/github.com/boltdb/bolt/bolt_mips64le.go     |  12 +++
 .../continuity/sysx/xattr_linux_mips64le.go        | 112 +++++++++++++++++++++
 .../docker/docker/pkg/signal/signal_linux.go       |   1 -
 .../docker/docker/pkg/system/stat_linux.go         |   2 +-
 .../runc/libcontainer/devices/devices.go           |   2 +-
 7 files changed, 127 insertions(+), 5 deletions(-)
 create mode 100644 vendor/github.com/boltdb/bolt/bolt_mips64le.go
 create mode 100644 vendor/github.com/containerd/continuity/sysx/xattr_linux_mips64le.go

diff --git a/Makefile.linux b/Makefile.linux
index 23dffad..58f8bc2 100644
--- a/Makefile.linux
+++ b/Makefile.linux
@@ -18,7 +18,7 @@ COMMANDS += containerd-shim
 
 # check GOOS for cross compile builds
 ifeq ($(GOOS),linux)
-	GO_GCFLAGS += -buildmode=pie
+	GO_GCFLAGS +=
 endif
 
 # amd64 supports go test -race
diff --git a/cmd/ctr/commands/signal_map_linux.go b/cmd/ctr/commands/signal_map_linux.go
index 11799ea..728099a 100644
--- a/cmd/ctr/commands/signal_map_linux.go
+++ b/cmd/ctr/commands/signal_map_linux.go
@@ -42,7 +42,6 @@ var signalMap = map[string]syscall.Signal{
 	"PWR":    unix.SIGPWR,
 	"QUIT":   unix.SIGQUIT,
 	"SEGV":   unix.SIGSEGV,
-	"STKFLT": unix.SIGSTKFLT,
 	"STOP":   unix.SIGSTOP,
 	"SYS":    unix.SIGSYS,
 	"TERM":   unix.SIGTERM,
diff --git a/vendor/github.com/boltdb/bolt/bolt_mips64le.go b/vendor/github.com/boltdb/bolt/bolt_mips64le.go
new file mode 100644
index 0000000..a46a9de
--- /dev/null
+++ b/vendor/github.com/boltdb/bolt/bolt_mips64le.go
@@ -0,0 +1,12 @@
+// +build mips64le
+
+package bolt
+
+// maxMapSize represents the largest mmap size supported by Bolt.
+const maxMapSize = 0xFFFFFFFFFFFF // 256TB
+
+// maxAllocSize is the size used when creating array pointers.
+const maxAllocSize = 0x7FFFFFFF
+
+// Are unaligned load/stores broken on this arch?
+var brokenUnaligned = false
diff --git a/vendor/github.com/containerd/continuity/sysx/xattr_linux_mips64le.go b/vendor/github.com/containerd/continuity/sysx/xattr_linux_mips64le.go
new file mode 100644
index 0000000..240ccf9
--- /dev/null
+++ b/vendor/github.com/containerd/continuity/sysx/xattr_linux_mips64le.go
@@ -0,0 +1,112 @@
+// mksyscall.pl xattr_linux.go
+// MACHINE GENERATED BY THE COMMAND ABOVE; DO NOT EDIT
+
+package sysx
+
+import (
+       "syscall"
+       "unsafe"
+)
+
+// THIS FILE IS GENERATED BY THE COMMAND AT THE TOP; DO NOT EDIT
+
+func llistxattr(path string, dest []byte) (sz int, err error) {
+       var _p0 *byte
+       _p0, err = syscall.BytePtrFromString(path)
+       if err != nil {
+               return
+       }
+       var _p1 unsafe.Pointer
+       if len(dest) > 0 {
+               _p1 = unsafe.Pointer(&dest[0])
+       } else {
+               _p1 = unsafe.Pointer(&_zero)
+       }
+       r0, _, e1 := syscall.Syscall(syscall.SYS_LLISTXATTR, uintptr(unsafe.Pointer(_p0)), uintptr(_p1), uintptr(len(dest)))
+       use(unsafe.Pointer(_p0))
+       sz = int(r0)
+       if e1 != 0 {
+               err = errnoErr(e1)
+       }
+       return
+}
+
+// THIS FILE IS GENERATED BY THE COMMAND AT THE TOP; DO NOT EDIT
+
+func lremovexattr(path string, attr string) (err error) {
+       var _p0 *byte
+       _p0, err = syscall.BytePtrFromString(path)
+       if err != nil {
+               return
+       }
+       var _p1 *byte
+       _p1, err = syscall.BytePtrFromString(attr)
+       if err != nil {
+               return
+       }
+       _, _, e1 := syscall.Syscall(syscall.SYS_LREMOVEXATTR, uintptr(unsafe.Pointer(_p0)), uintptr(unsafe.Pointer(_p1)), 0)
+       use(unsafe.Pointer(_p0))
+       use(unsafe.Pointer(_p1))
+       if e1 != 0 {
+               err = errnoErr(e1)
+       }
+       return
+}
+
+// THIS FILE IS GENERATED BY THE COMMAND AT THE TOP; DO NOT EDIT
+
+func lsetxattr(path string, attr string, data []byte, flags int) (err error) {
+       var _p0 *byte
+       _p0, err = syscall.BytePtrFromString(path)
+       if err != nil {
+               return
+       }
+       var _p1 *byte
+       _p1, err = syscall.BytePtrFromString(attr)
+       if err != nil {
+               return
+       }
+       var _p2 unsafe.Pointer
+       if len(data) > 0 {
+               _p2 = unsafe.Pointer(&data[0])
+       } else {
+               _p2 = unsafe.Pointer(&_zero)
+       }
+       _, _, e1 := syscall.Syscall6(syscall.SYS_LSETXATTR, uintptr(unsafe.Pointer(_p0)), uintptr(unsafe.Pointer(_p1)), uintptr(_p2), uintptr(len(data)), uintptr(flags), 0)
+       use(unsafe.Pointer(_p0))
+       use(unsafe.Pointer(_p1))
+       if e1 != 0 {
+               err = errnoErr(e1)
+       }
+       return
+}
+
+// THIS FILE IS GENERATED BY THE COMMAND AT THE TOP; DO NOT EDIT
+
+func lgetxattr(path string, attr string, dest []byte) (sz int, err error) {
+       var _p0 *byte
+       _p0, err = syscall.BytePtrFromString(path)
+       if err != nil {
+               return
+       }
+       var _p1 *byte
+       _p1, err = syscall.BytePtrFromString(attr)
+       if err != nil {
+               return
+       }
+       var _p2 unsafe.Pointer
+       if len(dest) > 0 {
+               _p2 = unsafe.Pointer(&dest[0])
+       } else {
+               _p2 = unsafe.Pointer(&_zero)
+       }
+       r0, _, e1 := syscall.Syscall6(syscall.SYS_LGETXATTR, uintptr(unsafe.Pointer(_p0)), uintptr(unsafe.Pointer(_p1)), uintptr(_p2), uintptr(len(dest)), 0, 0)
+       use(unsafe.Pointer(_p0))
+       use(unsafe.Pointer(_p1))
+       sz = int(r0)
+       if e1 != 0 {
+               err = errnoErr(e1)
+       }
+       return
+}
+
diff --git a/vendor/github.com/docker/docker/pkg/signal/signal_linux.go b/vendor/github.com/docker/docker/pkg/signal/signal_linux.go
index 66c85c8..4987aca 100644
--- a/vendor/github.com/docker/docker/pkg/signal/signal_linux.go
+++ b/vendor/github.com/docker/docker/pkg/signal/signal_linux.go
@@ -32,7 +32,6 @@ var SignalMap = map[string]syscall.Signal{
 	"PWR":      unix.SIGPWR,
 	"QUIT":     unix.SIGQUIT,
 	"SEGV":     unix.SIGSEGV,
-	"STKFLT":   unix.SIGSTKFLT,
 	"STOP":     unix.SIGSTOP,
 	"SYS":      unix.SIGSYS,
 	"TERM":     unix.SIGTERM,
diff --git a/vendor/github.com/docker/docker/pkg/system/stat_linux.go b/vendor/github.com/docker/docker/pkg/system/stat_linux.go
index 1939f95..af7af20 100644
--- a/vendor/github.com/docker/docker/pkg/system/stat_linux.go
+++ b/vendor/github.com/docker/docker/pkg/system/stat_linux.go
@@ -8,7 +8,7 @@ func fromStatT(s *syscall.Stat_t) (*StatT, error) {
 		mode: s.Mode,
 		uid:  s.Uid,
 		gid:  s.Gid,
-		rdev: s.Rdev,
+		rdev: uint64(s.Rdev),
 		mtim: s.Mtim}, nil
 }
 
diff --git a/vendor/github.com/opencontainers/runc/libcontainer/devices/devices.go b/vendor/github.com/opencontainers/runc/libcontainer/devices/devices.go
index 3619258..3079ffd 100644
--- a/vendor/github.com/opencontainers/runc/libcontainer/devices/devices.go
+++ b/vendor/github.com/opencontainers/runc/libcontainer/devices/devices.go
@@ -30,7 +30,7 @@ func DeviceFromPath(path, permissions string) (*configs.Device, error) {
 	}
 
 	var (
-		devNumber = stat.Rdev
+		devNumber = uint64(stat.Rdev)
 		major     = unix.Major(devNumber)
 	)
 	if major == 0 {
-- 
```

```
---
 vendor/golang.org/x/sys/unix/ztypes_linux_mips64le.go | 1 +
 1 file changed, 1 insertion(+)

diff --git a/vendor/golang.org/x/sys/unix/ztypes_linux_mips64le.go b/vendor/golang.org/x/sys/unix/ztypes_linux_mips64le.go
index bbe08d7..48798cc 100644
--- a/vendor/golang.org/x/sys/unix/ztypes_linux_mips64le.go
+++ b/vendor/golang.org/x/sys/unix/ztypes_linux_mips64le.go
@@ -637,6 +637,7 @@ type Ustat_t struct {
 
 type EpollEvent struct {
 	Events uint32
+	PadFd  int32
 	Fd     int32
 	Pad    int32
 }
-- 

```

# libnetwork

```
---
 vendor/golang.org/x/sys/unix/ztypes_linux_mips64.go | 1 +
 1 file changed, 1 insertion(+)

diff --git a/vendor/golang.org/x/sys/unix/ztypes_linux_mips64.go b/vendor/golang.org/x/sys/unix/ztypes_linux_mips64.go
index 01e8f65..5539bec 100644
--- a/vendor/golang.org/x/sys/unix/ztypes_linux_mips64.go
+++ b/vendor/golang.org/x/sys/unix/ztypes_linux_mips64.go
@@ -677,6 +677,7 @@ type Ustat_t struct {
 
 type EpollEvent struct {
 	Events uint32
+	PadFd  int32
 	Fd     int32
 	Pad    int32
 }
-- 
```


# runc

```shell
---
 vendor/golang.org/x/sys/unix/ztypes_linux_mips64le.go | 1 +
 1 file changed, 1 insertion(+)

diff --git a/vendor/golang.org/x/sys/unix/ztypes_linux_mips64le.go b/vendor/golang.org/x/sys/unix/ztypes_linux_mips64le.go
index f9bd1ab..19bdb3f 100644
--- a/vendor/golang.org/x/sys/unix/ztypes_linux_mips64le.go
+++ b/vendor/golang.org/x/sys/unix/ztypes_linux_mips64le.go
@@ -637,6 +637,7 @@ type Ustat_t struct {
 
 type EpollEvent struct {
 	Events uint32
+	PadFd  int32
 	Fd     int32
 	Pad    int32
 }
-- 

```

# dockerd/cli
```shell
---
 .../docker/docker/pkg/signal/signal_linux.go       |   1 -
 .../docker/docker/pkg/system/stat_linux.go         |   2 +-
 .../golang.org/x/sys/unix/ztypes_linux_mips64le.go |   1 +
 engine/daemon/graphdriver/copy/copy.go             |   2 +-
 engine/daemon/graphdriver/devmapper/deviceset.go   |   4 +-
 .../hack/dockerfile/install/containerd.installer   |  13 +--
 engine/hack/dockerfile/install/install.sh          |   2 +-
 engine/hack/dockerfile/install/proxy.installer     |   7 +-
 engine/hack/dockerfile/install/runc.installer      |   8 +-
 engine/hack/dockerfile/install/tini.installer      |   6 +-
 engine/hack/make/.binary                           |   6 +-
 engine/pkg/loopback/loopback.go                    |   2 +-
 engine/pkg/signal/signal_linux.go                  |   1 -
 engine/pkg/system/stat_linux.go                    |   2 +-
 .../vendor/github.com/boltdb/bolt/bolt_mips64le.go |  13 +++
 .../continuity/sysx/xattr_linux_mips64le.go        | 112 +++++++++++++++++++++
 .../runc/libcontainer/devices/devices.go           |   2 +-
 .../vishvananda/netns/netns_linux_mips64le.go      |   8 ++
 .../golang.org/x/sys/unix/ztypes_linux_mips64le.go |   1 +
 19 files changed, 165 insertions(+), 28 deletions(-)
 create mode 100644 engine/vendor/github.com/boltdb/bolt/bolt_mips64le.go
 create mode 100644 engine/vendor/github.com/containerd/continuity/sysx/xattr_linux_mips64le.go
 create mode 100644 engine/vendor/github.com/vishvananda/netns/netns_linux_mips64le.go

diff --git a/cli/vendor/github.com/docker/docker/pkg/signal/signal_linux.go b/cli/vendor/github.com/docker/docker/pkg/signal/signal_linux.go
index caed97c..c9bab45 100644
--- a/cli/vendor/github.com/docker/docker/pkg/signal/signal_linux.go
+++ b/cli/vendor/github.com/docker/docker/pkg/signal/signal_linux.go
@@ -32,7 +32,6 @@ var SignalMap = map[string]syscall.Signal{
 	"PWR":      unix.SIGPWR,
 	"QUIT":     unix.SIGQUIT,
 	"SEGV":     unix.SIGSEGV,
-	"STKFLT":   unix.SIGSTKFLT,
 	"STOP":     unix.SIGSTOP,
 	"SYS":      unix.SIGSYS,
 	"TERM":     unix.SIGTERM,
diff --git a/cli/vendor/github.com/docker/docker/pkg/system/stat_linux.go b/cli/vendor/github.com/docker/docker/pkg/system/stat_linux.go
index 98c9eb1..8a090a5 100644
--- a/cli/vendor/github.com/docker/docker/pkg/system/stat_linux.go
+++ b/cli/vendor/github.com/docker/docker/pkg/system/stat_linux.go
@@ -8,7 +8,7 @@ func fromStatT(s *syscall.Stat_t) (*StatT, error) {
 		mode: s.Mode,
 		uid:  s.Uid,
 		gid:  s.Gid,
-		rdev: s.Rdev,
+		rdev: uint64(s.Rdev),
 		mtim: s.Mtim}, nil
 }
 
diff --git a/cli/vendor/golang.org/x/sys/unix/ztypes_linux_mips64le.go b/cli/vendor/golang.org/x/sys/unix/ztypes_linux_mips64le.go
index 6f9452d..0b279cc 100644
--- a/cli/vendor/golang.org/x/sys/unix/ztypes_linux_mips64le.go
+++ b/cli/vendor/golang.org/x/sys/unix/ztypes_linux_mips64le.go
@@ -677,6 +677,7 @@ type Ustat_t struct {
 
 type EpollEvent struct {
 	Events uint32
+	PadFd  int32
 	Fd     int32
 	Pad    int32
 }
diff --git a/engine/daemon/graphdriver/copy/copy.go b/engine/daemon/graphdriver/copy/copy.go
index 86316fd..d3e862e 100644
--- a/engine/daemon/graphdriver/copy/copy.go
+++ b/engine/daemon/graphdriver/copy/copy.go
@@ -154,7 +154,7 @@ func DirCopy(srcDir, dstDir string, copyMode Mode, copyXattrs bool) error {
 
 		switch f.Mode() & os.ModeType {
 		case 0: // Regular file
-			id := fileID{dev: stat.Dev, ino: stat.Ino}
+			id := fileID{dev: uint64(stat.Dev), ino: stat.Ino}
 			if copyMode == Hardlink {
 				isHardlink = true
 				if err2 := os.Link(srcPath, dstPath); err2 != nil {
diff --git a/engine/daemon/graphdriver/devmapper/deviceset.go b/engine/daemon/graphdriver/devmapper/deviceset.go
index 2bfbf05..b2017ec 100644
--- a/engine/daemon/graphdriver/devmapper/deviceset.go
+++ b/engine/daemon/graphdriver/devmapper/deviceset.go
@@ -1527,7 +1527,7 @@ func getDeviceMajorMinor(file *os.File) (uint64, uint64, error) {
 		return 0, 0, err
 	}
 
-	dev := stat.Rdev
+	dev := uint64(stat.Rdev)
 	majorNum := major(dev)
 	minorNum := minor(dev)
 
@@ -1738,7 +1738,7 @@ func (devices *DeviceSet) initDevmapper(doInit bool) (retErr error) {
 	//	- Managed by docker
 	//	- The target of this device is at major <maj> and minor <min>
 	//	- If <inode> is defined, use that file inside the device as a loopback image. Otherwise use the device itself.
-	devices.devicePrefix = fmt.Sprintf("docker-%d:%d-%d", major(st.Dev), minor(st.Dev), st.Ino)
+	devices.devicePrefix = fmt.Sprintf("docker-%d:%d-%d", major(uint64(st.Dev)), minor(uint64(st.Dev)), st.Ino)
 	logger.Debugf("Generated prefix: %s", devices.devicePrefix)
 
 	// Check for the existence of the thin-pool device
diff --git a/engine/hack/dockerfile/install/containerd.installer b/engine/hack/dockerfile/install/containerd.installer
index dceae49..07a27d2 100755
--- a/engine/hack/dockerfile/install/containerd.installer
+++ b/engine/hack/dockerfile/install/containerd.installer
@@ -8,10 +8,11 @@ CONTAINERD_COMMIT=468a545b9edcd5932818eb9de8e72413e616e86e # v1.1.2
 
 install_containerd() {
 	echo "Install containerd version $CONTAINERD_COMMIT"
-	git clone https://github.com/containerd/containerd.git "$GOPATH/src/github.com/containerd/containerd"
+	#git clone https://github.com/containerd/containerd.git "$GOPATH/src/github.com/containerd/containerd"
 	cd "$GOPATH/src/github.com/containerd/containerd"
 	git checkout -q "$CONTAINERD_COMMIT"
-
+	patch -p1 < 0001-containerd-fix-build-error-on-mips64le-platform.patch
+	patch -p1 < 0001-containerd-Fix-EpollEvent-define-for-mips64le.patch
 	(
 
 		export BUILDTAGS='static_build netgo'
@@ -28,9 +29,9 @@ install_containerd() {
 		make
 	)
 
-	mkdir -p ${PREFIX}
+	mkdir -p ${BIN_DIR}
 
-	cp bin/containerd ${PREFIX}/docker-containerd
-	cp bin/containerd-shim ${PREFIX}/docker-containerd-shim
-	cp bin/ctr ${PREFIX}/docker-containerd-ctr
+	cp bin/containerd ${BIN_DIR}/docker-containerd
+	cp bin/containerd-shim ${BIN_DIR}/docker-containerd-shim
+	cp bin/ctr ${BIN_DIR}/docker-containerd-ctr
 }
diff --git a/engine/hack/dockerfile/install/install.sh b/engine/hack/dockerfile/install/install.sh
index a0ff09d..249182b 100755
--- a/engine/hack/dockerfile/install/install.sh
+++ b/engine/hack/dockerfile/install/install.sh
@@ -7,7 +7,7 @@ RM_GOPATH=0
 
 TMP_GOPATH=${TMP_GOPATH:-""}
 
-: ${PREFIX:="/usr/local/bin"}
+: ${BIN_DIR:="${HOME}/docker-bin"}
 
 if [ -z "$TMP_GOPATH" ]; then
 	export GOPATH="$(mktemp -d)"
diff --git a/engine/hack/dockerfile/install/proxy.installer b/engine/hack/dockerfile/install/proxy.installer
index 4983d90..19350fc 100755
--- a/engine/hack/dockerfile/install/proxy.installer
+++ b/engine/hack/dockerfile/install/proxy.installer
@@ -23,16 +23,17 @@ install_proxy() {
 
 install_proxy_dynamic() {
 	export PROXY_LDFLAGS="-linkmode=external" install_proxy
-	export BUILD_MODE="-buildmode=pie"
+	#export BUILD_MODE="-buildmode=pie"
 	_install_proxy
 }
 
 _install_proxy() {
 	echo "Install docker-proxy version $LIBNETWORK_COMMIT"
-	git clone https://github.com/docker/libnetwork.git "$GOPATH/src/github.com/docker/libnetwork"
+	#git clone https://github.com/docker/libnetwork.git "$GOPATH/src/github.com/docker/libnetwork"
 	cd "$GOPATH/src/github.com/docker/libnetwork"
 	git checkout -q "$LIBNETWORK_COMMIT"
-	go build $BUILD_MODE -ldflags="$PROXY_LDFLAGS" -o ${PREFIX}/docker-proxy github.com/docker/libnetwork/cmd/proxy
+	patch -p1 < 0001-libnetwork-Fix-EpollEvent-define-for-mips64le.patch
+	go build $BUILD_MODE -ldflags="$PROXY_LDFLAGS" -o ${BIN_DIR}/docker-proxy github.com/docker/libnetwork/cmd/proxy
 }
 
 
diff --git a/engine/hack/dockerfile/install/runc.installer b/engine/hack/dockerfile/install/runc.installer
index 43b5504..17d834e 100755
--- a/engine/hack/dockerfile/install/runc.installer
+++ b/engine/hack/dockerfile/install/runc.installer
@@ -8,9 +8,11 @@ install_runc() {
 	RUNC_BUILDTAGS="${RUNC_BUILDTAGS:-"seccomp apparmor selinux"}"
 
 	echo "Install runc version $RUNC_COMMIT"
-	git clone https://github.com/docker/runc.git "$GOPATH/src/github.com/opencontainers/runc"
+	#git clone https://github.com/docker/runc.git "$GOPATH/src/github.com/opencontainers/runc"
 	cd "$GOPATH/src/github.com/opencontainers/runc"
 	git checkout -q "$RUNC_COMMIT"
+	patch -p1 < 0001-runc-Fix-EpollEvent-define-for-mips64le.patch
+	sed -i 's@-buildmode=pie @@g' Makefile
 	if [ -z "$1" ]; then
 		target=static
 	else
@@ -18,6 +20,6 @@ install_runc() {
 	fi
 	# TODO: Remove me before 18.06.4
 	make BUILDTAGS="$RUNC_BUILDTAGS" VERSION="1.0.0-rc5+dev.docker-18.06" "$target"
-	mkdir -p ${PREFIX}
-	cp runc ${PREFIX}/docker-runc
+	mkdir -p ${BIN_DIR}
+	cp runc ${BIN_DIR}/docker-runc
 }
diff --git a/engine/hack/dockerfile/install/tini.installer b/engine/hack/dockerfile/install/tini.installer
index 34f43f1..fba49b4 100755
--- a/engine/hack/dockerfile/install/tini.installer
+++ b/engine/hack/dockerfile/install/tini.installer
@@ -4,11 +4,11 @@ TINI_COMMIT=fec3683b971d9c3ef73f284f176672c44b448662 # v0.18.0
 
 install_tini() {
 	echo "Install tini version $TINI_COMMIT"
-	git clone https://github.com/krallin/tini.git "$GOPATH/tini"
+	#git clone https://github.com/krallin/tini.git "$GOPATH/tini"
 	cd "$GOPATH/tini"
 	git checkout -q "$TINI_COMMIT"
 	cmake .
 	make tini-static
-	mkdir -p ${PREFIX}
-	cp tini-static ${PREFIX}/docker-init
+	mkdir -p ${BIN_DIR}
+	cp tini-static ${BIN_DIR}/docker-init
 }
diff --git a/engine/hack/make/.binary b/engine/hack/make/.binary
index 9375926..23a039c 100644
--- a/engine/hack/make/.binary
+++ b/engine/hack/make/.binary
@@ -51,9 +51,9 @@ if [ "$(go env GOOS)/$(go env GOARCH)" != "$(go env GOHOSTOS)/$(go env GOHOSTARC
 fi
 
 # -buildmode=pie is not supported on Windows.
-if [ "$(go env GOOS)" != "windows" ]; then
-	BUILDFLAGS+=( "-buildmode=pie" )
-fi
+#if [ "$(go env GOOS)" != "windows" ]; then
+#	BUILDFLAGS+=( "-buildmode=pie" )
+#fi
 
 echo "Building: $DEST/$BINARY_FULLNAME"
 go build \
diff --git a/engine/pkg/loopback/loopback.go b/engine/pkg/loopback/loopback.go
index 086655b..b5d0bfc 100644
--- a/engine/pkg/loopback/loopback.go
+++ b/engine/pkg/loopback/loopback.go
@@ -54,7 +54,7 @@ func FindLoopDeviceFor(file *os.File) *os.File {
 		}
 
 		dev, inode, err := getLoopbackBackingFile(file)
-		if err == nil && dev == targetDevice && inode == targetInode {
+		if err == nil && dev == uint64(targetDevice) && inode == targetInode {
 			return file
 		}
 		file.Close()
diff --git a/engine/pkg/signal/signal_linux.go b/engine/pkg/signal/signal_linux.go
index caed97c..c9bab45 100644
--- a/engine/pkg/signal/signal_linux.go
+++ b/engine/pkg/signal/signal_linux.go
@@ -32,7 +32,6 @@ var SignalMap = map[string]syscall.Signal{
 	"PWR":      unix.SIGPWR,
 	"QUIT":     unix.SIGQUIT,
 	"SEGV":     unix.SIGSEGV,
-	"STKFLT":   unix.SIGSTKFLT,
 	"STOP":     unix.SIGSTOP,
 	"SYS":      unix.SIGSYS,
 	"TERM":     unix.SIGTERM,
diff --git a/engine/pkg/system/stat_linux.go b/engine/pkg/system/stat_linux.go
index 98c9eb1..8a090a5 100644
--- a/engine/pkg/system/stat_linux.go
+++ b/engine/pkg/system/stat_linux.go
@@ -8,7 +8,7 @@ func fromStatT(s *syscall.Stat_t) (*StatT, error) {
 		mode: s.Mode,
 		uid:  s.Uid,
 		gid:  s.Gid,
-		rdev: s.Rdev,
+		rdev: uint64(s.Rdev),
 		mtim: s.Mtim}, nil
 }
 
diff --git a/engine/vendor/github.com/boltdb/bolt/bolt_mips64le.go b/engine/vendor/github.com/boltdb/bolt/bolt_mips64le.go
new file mode 100644
index 0000000..0876965
--- /dev/null
+++ b/engine/vendor/github.com/boltdb/bolt/bolt_mips64le.go
@@ -0,0 +1,13 @@
+// +build mips64le
+
+package bolt
+
+// maxMapSize represents the largest mmap size supported by Bolt.
+const maxMapSize = 0xFFFFFFFFFFFF // 256TB
+
+// maxAllocSize is the size used when creating array pointers.
+const maxAllocSize = 0x7FFFFFFF
+
+// Are unaligned load/stores broken on this arch?
+var brokenUnaligned = false
+
diff --git a/engine/vendor/github.com/containerd/continuity/sysx/xattr_linux_mips64le.go b/engine/vendor/github.com/containerd/continuity/sysx/xattr_linux_mips64le.go
new file mode 100644
index 0000000..240ccf9
--- /dev/null
+++ b/engine/vendor/github.com/containerd/continuity/sysx/xattr_linux_mips64le.go
@@ -0,0 +1,112 @@
+// mksyscall.pl xattr_linux.go
+// MACHINE GENERATED BY THE COMMAND ABOVE; DO NOT EDIT
+
+package sysx
+
+import (
+       "syscall"
+       "unsafe"
+)
+
+// THIS FILE IS GENERATED BY THE COMMAND AT THE TOP; DO NOT EDIT
+
+func llistxattr(path string, dest []byte) (sz int, err error) {
+       var _p0 *byte
+       _p0, err = syscall.BytePtrFromString(path)
+       if err != nil {
+               return
+       }
+       var _p1 unsafe.Pointer
+       if len(dest) > 0 {
+               _p1 = unsafe.Pointer(&dest[0])
+       } else {
+               _p1 = unsafe.Pointer(&_zero)
+       }
+       r0, _, e1 := syscall.Syscall(syscall.SYS_LLISTXATTR, uintptr(unsafe.Pointer(_p0)), uintptr(_p1), uintptr(len(dest)))
+       use(unsafe.Pointer(_p0))
+       sz = int(r0)
+       if e1 != 0 {
+               err = errnoErr(e1)
+       }
+       return
+}
+
+// THIS FILE IS GENERATED BY THE COMMAND AT THE TOP; DO NOT EDIT
+
+func lremovexattr(path string, attr string) (err error) {
+       var _p0 *byte
+       _p0, err = syscall.BytePtrFromString(path)
+       if err != nil {
+               return
+       }
+       var _p1 *byte
+       _p1, err = syscall.BytePtrFromString(attr)
+       if err != nil {
+               return
+       }
+       _, _, e1 := syscall.Syscall(syscall.SYS_LREMOVEXATTR, uintptr(unsafe.Pointer(_p0)), uintptr(unsafe.Pointer(_p1)), 0)
+       use(unsafe.Pointer(_p0))
+       use(unsafe.Pointer(_p1))
+       if e1 != 0 {
+               err = errnoErr(e1)
+       }
+       return
+}
+
+// THIS FILE IS GENERATED BY THE COMMAND AT THE TOP; DO NOT EDIT
+
+func lsetxattr(path string, attr string, data []byte, flags int) (err error) {
+       var _p0 *byte
+       _p0, err = syscall.BytePtrFromString(path)
+       if err != nil {
+               return
+       }
+       var _p1 *byte
+       _p1, err = syscall.BytePtrFromString(attr)
+       if err != nil {
+               return
+       }
+       var _p2 unsafe.Pointer
+       if len(data) > 0 {
+               _p2 = unsafe.Pointer(&data[0])
+       } else {
+               _p2 = unsafe.Pointer(&_zero)
+       }
+       _, _, e1 := syscall.Syscall6(syscall.SYS_LSETXATTR, uintptr(unsafe.Pointer(_p0)), uintptr(unsafe.Pointer(_p1)), uintptr(_p2), uintptr(len(data)), uintptr(flags), 0)
+       use(unsafe.Pointer(_p0))
+       use(unsafe.Pointer(_p1))
+       if e1 != 0 {
+               err = errnoErr(e1)
+       }
+       return
+}
+
+// THIS FILE IS GENERATED BY THE COMMAND AT THE TOP; DO NOT EDIT
+
+func lgetxattr(path string, attr string, dest []byte) (sz int, err error) {
+       var _p0 *byte
+       _p0, err = syscall.BytePtrFromString(path)
+       if err != nil {
+               return
+       }
+       var _p1 *byte
+       _p1, err = syscall.BytePtrFromString(attr)
+       if err != nil {
+               return
+       }
+       var _p2 unsafe.Pointer
+       if len(dest) > 0 {
+               _p2 = unsafe.Pointer(&dest[0])
+       } else {
+               _p2 = unsafe.Pointer(&_zero)
+       }
+       r0, _, e1 := syscall.Syscall6(syscall.SYS_LGETXATTR, uintptr(unsafe.Pointer(_p0)), uintptr(unsafe.Pointer(_p1)), uintptr(_p2), uintptr(len(dest)), 0, 0)
+       use(unsafe.Pointer(_p0))
+       use(unsafe.Pointer(_p1))
+       sz = int(r0)
+       if e1 != 0 {
+               err = errnoErr(e1)
+       }
+       return
+}
+
diff --git a/engine/vendor/github.com/opencontainers/runc/libcontainer/devices/devices.go b/engine/vendor/github.com/opencontainers/runc/libcontainer/devices/devices.go
index 3619258..3079ffd 100644
--- a/engine/vendor/github.com/opencontainers/runc/libcontainer/devices/devices.go
+++ b/engine/vendor/github.com/opencontainers/runc/libcontainer/devices/devices.go
@@ -30,7 +30,7 @@ func DeviceFromPath(path, permissions string) (*configs.Device, error) {
 	}
 
 	var (
-		devNumber = stat.Rdev
+		devNumber = uint64(stat.Rdev)
 		major     = unix.Major(devNumber)
 	)
 	if major == 0 {
diff --git a/engine/vendor/github.com/vishvananda/netns/netns_linux_mips64le.go b/engine/vendor/github.com/vishvananda/netns/netns_linux_mips64le.go
new file mode 100644
index 0000000..90d3031
--- /dev/null
+++ b/engine/vendor/github.com/vishvananda/netns/netns_linux_mips64le.go
@@ -0,0 +1,8 @@
+// +build linux,mips64le
+
+package netns
+
+const (
+       SYS_SETNS = 5303
+)
+
diff --git a/engine/vendor/golang.org/x/sys/unix/ztypes_linux_mips64le.go b/engine/vendor/golang.org/x/sys/unix/ztypes_linux_mips64le.go
index 6f9452d..0b279cc 100644
--- a/engine/vendor/golang.org/x/sys/unix/ztypes_linux_mips64le.go
+++ b/engine/vendor/golang.org/x/sys/unix/ztypes_linux_mips64le.go
@@ -677,6 +677,7 @@ type Ustat_t struct {
 
 type EpollEvent struct {
 	Events uint32
+	PadFd  int32
 	Fd     int32
 	Pad    int32
 }
-- 
```

# 注意

```go
 type EpollEvent struct {
 	Events uint32
+	PadFd  int32
 	Fd     int32
 	Pad    int32
 }
```
EpollEvent 这个struct都需要添加PadFd，否则会有问题，例如docker exec 会卡住等。

# 编译
我这里是手工编译的，例如：

dockerd/cli:
```bash
VERSION=v18.09.8 GITCOMMIT=456712c5b8 ./hack/make.sh
VERSION=v18.09.8 make
```

runc:

~~make BUILDTAGS='seccomp apparmor' static~~


这里注意如果静态编译runc/docker的话，是不支持systemd的cgroup driver。相关[issues](https://github.com/moby/moby/issues/38753#issuecomment-465290976)。

```
make BUILDTAGS='seccomp apparmor'
```

docker-proxy

```
CGO_ENABLED=0 go build -ldflags="-linkmode=external"         -o ./docker-proxy         github.com/docker/libnetwork/cmd/proxy
```

init:
```
cmake . && make tini-static
```

containerd:
```
make
```


# 构建deb

这里二进制生成后，构建deb即可。

